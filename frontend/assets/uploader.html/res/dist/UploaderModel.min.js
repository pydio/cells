/*! For license information please see UploaderModel.min.js.LICENSE.txt */
(()=>{var t={381:function(t,e){var r,n;function o(t){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o(t)}void 0===(n="function"==typeof(r=function(){"use strict";var t=function(){this._listeners={}};t.prototype.addEventListener=function(t,e){this._listeners[t]=this._listeners[t]||[],this._listeners[t].indexOf(e)<0&&this._listeners[t].push(e)},t.prototype.removeEventListener=function(t,e){if(this._listeners[t]){var r=this._listeners[t].indexOf(e);r>=0&&this._listeners[t].splice(r,1)}},t.prototype.dispatchEvent=function(t){if(this._listeners[t.type]&&this._listeners[t.type].length)for(var e=this._listeners[t.type].slice(),r=0,n=e.length;r<n;++r)e[r].call(this,t)};var e=function(t){var e=!1;return{next:function(){return e?{done:!0}:(e=!0,{value:t})}}},r=function(t,e,r){this.target=t,this.type=e,this.data=r},n=function(r,n,i){if(t.call(this),"number"!=typeof n||Math.floor(n)!==n||n<1)throw new Error("Invalid concurrency");this._concurrency=n,this._options=i||{},this._options.promise=this._options.promise||Promise,this._iterator=function(t,r){var n,i=o(t);if("object"===i){if("function"==typeof t.next)return t;if("function"==typeof t.then)return e(t)}return"function"===i?"function"==typeof(n=t).constructor&&"GeneratorFunction"===n.constructor.name?t():function(t){return{next:function(){var e=t();return e?{value:e}:{done:!0}}}}(t):e(r.resolve(t))}(r,this._options.promise),this._done=!1,this._size=0,this._promise=null,this._callbacks=null};return(n.prototype=new t).constructor=n,n.prototype.concurrency=function(t){return void 0!==t&&(this._concurrency=t,this.active()&&this._proceed()),this._concurrency},n.prototype.size=function(){return this._size},n.prototype.active=function(){return!!this._promise},n.prototype.promise=function(){return this._promise},n.prototype.start=function(){var t=this,e=this._options.promise;return this._promise=new e((function(e,r){t._callbacks={reject:r,resolve:e},t._proceed()})),this._promise},n.prototype._fireEvent=function(t,e){this.dispatchEvent(new r(this,t,e))},n.prototype._settle=function(t){t?this._callbacks.reject(t):this._callbacks.resolve(),this._promise=null,this._callbacks=null},n.prototype._onPooledPromiseFulfilled=function(t,e){this._size--,this.active()&&(this._fireEvent("fulfilled",{promise:t,result:e}),this._proceed())},n.prototype._onPooledPromiseRejected=function(t,e){this._size--,this.active()&&(this._fireEvent("rejected",{promise:t,error:e}),this._settle(e||new Error("Unknown error")))},n.prototype._trackPromise=function(t){var e=this;t.then((function(r){e._onPooledPromiseFulfilled(t,r)}),(function(r){e._onPooledPromiseRejected(t,r)})).catch((function(t){e._settle(new Error("Promise processing failed: "+t))}))},n.prototype._proceed=function(){if(!this._done){for(var t={done:!1};this._size<this._concurrency&&!(t=this._iterator.next()).done;)this._size++,this._trackPromise(t.value);this._done=null===t||!!t.done}this._done&&0===this._size&&this._settle()},n.PromisePoolEvent=r,n.PromisePool=n,n})?r.apply(e,[]):r)||(t.exports=n)}},e={};function r(n){var o=e[n];if(void 0!==o)return o.exports;var i=e[n]={exports:{}};return t[n].call(i.exports,i,i.exports,r),i.exports}r.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return r.d(e,{a:e}),e},r.d=(t,e)=>{for(var n in e)r.o(e,n)&&!r.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};(()=>{"use strict";r.r(n),r.d(n,{Configs:()=>T,FolderItem:()=>V,PartItem:()=>N,Session:()=>ot,Store:()=>ft,UploadItem:()=>q});const t=require("pydio");var e=r.n(t);const o=require("pydio/util/lang");var i=r.n(o);const s=require("pydio/util/path");var a=r.n(s);const u=require("pydio/lang/observable");var c=r.n(u);const l=require("cells-sdk");function f(t){return f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},f(t)}function h(t){return function(t){if(Array.isArray(t))return p(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return p(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?p(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function y(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==f(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==f(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===f(o)?o:String(o)),n)}var o}function d(t,e){return d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},d(t,e)}function v(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function g(t){return g=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},g(t)}var b=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&d(t,e)}(a,t);var r,n,o,i,s=(o=a,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=g(o);if(i){var r=g(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return function(t,e){if(e&&("object"===f(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return v(t)}(this,t)});function a(t,r){var n,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,a),(n=s.call(this))._status=a.StatusNew,n._type=t,n._id=Math.random(),n._errorMessage=null;var i=e().getInstance();return n._repositoryId=o?o.getRepositoryId():i.user.activeRepository,n._exists=!1,n._progress=0,n.children={folders:[],files:[],pg:{}},n._targetNode=r,o&&(n._parent=o,t===a.TypeFolder?o.children.folders.push(v(n)):o.children.files.push(v(n))),n}return r=a,n=[{key:"getId",value:function(){return this._id}},{key:"getParent",value:function(){return this._parent}},{key:"getLabel",value:function(){return this._label&&this._label.normalize?this._label.normalize("NFC"):this._label}},{key:"updateTargetNode",value:function(t){this._targetNode=t}},{key:"getTargetNode",value:function(){return this._targetNode}},{key:"updateLabel",value:function(t){this._label=t,this.notify("update_label",t)}},{key:"getFullPath",value:function(){return this._parent.getFullPath()+"/"+this.getLabel()}},{key:"getProgress",value:function(){return this._progress}},{key:"setExists",value:function(){this._exists=!0}},{key:"getExists",value:function(){return this._exists}},{key:"getType",value:function(){return this._type}},{key:"getStatus",value:function(){return this._status}},{key:"setStatus",value:function(t){this._status=t,this.notify("status",t)}},{key:"updateRepositoryId",value:function(t){this._repositoryId=t}},{key:"getRepositoryId",value:function(){return this._repositoryId}},{key:"getErrorMessage",value:function(){return this._errorMessage||""}},{key:"onError",value:function(t){this._errorMessage=t,this.setStatus(a.StatusError)}},{key:"process",value:function(t){this._doProcess(t)}},{key:"abort",value:function(t){this._doAbort&&this._doAbort(t)}},{key:"pause",value:function(){if(this._doPause){var t=this._doPause();this.setStatus(t)}}},{key:"resume",value:function(){this._doResume&&(this._doResume(),this.setStatus(a.StatusLoading))}},{key:"addChild",value:function(t){var e=this;this.children.pg[t.getId()]=0,t.observe("progress",(function(r){e.children.pg[t.getId()]=r,e.recomputeProgress()})),this.notify("child_added")}},{key:"recomputeProgress",value:function(){var t=this,e=Object.keys(this.children.pg).map((function(e){return t.children.pg[e]}));if(e.length){var r=e.reduce((function(t,e){return t+e}));this._progress=r/e.length,this.notify("progress",this._progress)}}},{key:"removeChild",value:function(t){t.abort(),t.walk((function(t){t.abort()}),(function(){return!0}),a.TypeFile);var e=t.getId(),r=this.children.folders.indexOf(t),n=this.children.files.indexOf(t),o=!1;r>-1?(this.children.folders=LangUtils.arrayWithout(this.children.folders,r),o=!0):n>-1&&(this.children.files=LangUtils.arrayWithout(this.children.files,n),o=!0),o&&(t.stopObserving("progress"),delete this.children.pg[e],this.recomputeProgress(),this.notify("children"))}},{key:"getChildren",value:function(){return[].concat(h(this.children.folders),h(this.children.files))}},{key:"walk",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!0},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:a.TypeBoth,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(t){return!1},o=!1;if(r===a.TypeBoth||r===a.TypeFile)for(var i=this.children.files,s=0;s<i.length;s++){if(n(i[s])){o=!0;break}e(i[s])&&t(i[s])}o||this.children.folders.forEach((function(o){r!==a.TypeFolder&&r!==a.TypeBoth||!e(o)||t(o),n(o)||o.walk(t,e,r,n)}))}},{key:"collectWithLimit",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!0},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"both",n=[];return this.walk((function(t){n.push(t)}),e,r,(function(e){return n.length>=t})),n}}],n&&y(r.prototype,n),Object.defineProperty(r,"prototype",{writable:!1}),a}(c());function m(t){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},m(t)}function _(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==m(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==m(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===m(o)?o:String(o)),n)}var o}b.StatusNew="new",b.StatusAnalyze="analyse",b.StatusFolders="folders",b.StatusLoading="loading",b.StatusLoaded="loaded",b.StatusError="error",b.StatusPause="pause",b.StatusCannotPause="cannot-pause",b.StatusMultiPause="multi-pause",b.TypeFolder="folder",b.TypeFile="file",b.TypeBoth="both";var S=e().requireLib("boot").JobsStore,w=function(){function t(r){var n=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var o=e().getInstance();this.job=new l.JobsJob,this.job.ID="local-upload-task-"+r.getId(),this.job.Owner=o.user.id;var i=function(t){return o.MessageHash["html_uploader.task."+t]||t};this.job.Label=i("label"),this.job.Stoppable=!0;var s=new l.JobsTask;this.task=s,this.job.Tasks=[this.task],this.task.HasProgress=!0,this.task.ID="upload",this.task.Status=l.JobsTaskStatus.constructFromObject("Idle"),this.job.openDetailPane=function(){o.Controller.fireAction("upload")},s._statusObserver=function(t){if(t===b.StatusFolders&&r.getCreateFolders()){n.job.Label=i("status.folders");var e=r.getCreateFolders();s.StatusMessage=e>1?i("message.folder-many").replace("%s",e):i("message.folder-one"),s.Status=l.JobsTaskStatus.constructFromObject("Running")}else if(t===b.StatusAnalyze){n.job.Label=i("status.analyse");var o=r.getChildren().length;s.StatusMessage=o>1?i("message.analyse-many").replace("%s",o):i(1===o?"message.analyse-one":"message.analyse-wait"),s.Status=l.JobsTaskStatus.constructFromObject("Running")}else"ready"===t?(n.job.Label=i("7"),s.StatusMessage=i("status.ready"),s.Status=l.JobsTaskStatus.constructFromObject("Idle")):"paused"===t?(n.job.Label=i("status.paused"),s.Status=l.JobsTaskStatus.constructFromObject("Paused")):"loading"===t&&(n.job.Label=i("status.upload"),s.Status=l.JobsTaskStatus.constructFromObject("Running"));n.notifyMainStore()},s._progressObserver=function(t){n.job.Label=i("status.upload"),s.Progress=t/100,s.Status=l.JobsTaskStatus.constructFromObject("Running"),t>0&&(s.StatusMessage=i("message.upload-progress").replace("%s",Math.ceil(t))),n.notifyMainStore()},r.observe("status",s._statusObserver),r.observe("progress",s._progressObserver),s._statusObserver(r.getStatus()),s._progressObserver(r.getProgress()),S.getInstance().enqueueLocalJob(this.job)}var r,n,o;return r=t,o=[{key:"create",value:function(e){return new t(e)}}],(n=[{key:"setIdle",value:function(){1!==this.task.Progress?(this.task.Status=l.JobsTaskStatus.constructFromObject("Idle"),this.task.StatusMessage="",this.notifyMainStore()):S.getInstance().deleteLocalJob(this.job.ID)}},{key:"notifyMainStore",value:function(){1!==this.task.Progress&&(this.task.StartTime=(new Date).getTime()/1e3,this.job.Tasks=[this.task],S.getInstance().enqueueLocalJob(this.job))}}])&&_(r.prototype,n),o&&_(r,o),Object.defineProperty(r,"prototype",{writable:!1}),t}();function P(t){return P="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},P(t)}function k(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==P(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==P(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===P(o)?o:String(o)),n)}var o}function O(t,e){return O=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},O(t,e)}function E(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function j(t){return j=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},j(t)}var T=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&O(t,e)}(c,t);var r,n,o,i,s,u=(i=c,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=j(i);if(s){var r=j(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return function(t,e){if(e&&("object"===P(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return E(t)}(this,t)});function c(){var t;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,c),t=u.call(this),e().getInstance().observe("registry_loaded",function(){this._global=null}.bind(E(t))),t}return r=c,n=[{key:"_loadOptions",value:function(){this._global||(this._global=e().getInstance().getPluginConfigs("uploader"))}},{key:"getOptionAsBool",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,n=this.getOption(t,e,r);return!0===n||"true"===n}},{key:"getOption",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;if(this._loadOptions(),e){var n=c.getUserPreference(e);if(null!=n)return n}return this._global.has(t)?this._global.get(t):void 0!==r?r:null}},{key:"getAutoStart",value:function(){return this.getOptionAsBool("DEFAULT_AUTO_START","upload_auto_send")}},{key:"getAutoClose",value:function(){return this.getOptionAsBool("DEFAULT_AUTO_CLOSE","upload_auto_close")}},{key:"updateOption",value:function(t,e){arguments.length>2&&void 0!==arguments[2]&&arguments[2]&&(e=e?"true":"false"),c.setUserPreference(t,e),this.notify("change")}},{key:"extensionAllowed",value:function(t){var r=this.getOption("ALLOWED_EXTENSIONS","","");if(r){var n=this.getOption("ALLOWED_EXTENSIONS_READABLE","","");n&&(n=" ("+n+")");var o=a().getFileExtension(t.getLabel());if(-1===r.split(",").indexOf(o))throw new Error(e().getInstance().MessageHash[367]+r+n)}}}],o=[{key:"getInstance",value:function(){return c.__INSTANCE||(c.__INSTANCE=new c),c.__INSTANCE}},{key:"getUserPreference",value:function(t){var r=e().getInstance();return r.user?r.user.getLayoutPreference("Uploaders.Html."+t):null}},{key:"setUserPreference",value:function(t,r){var n=e().getInstance();n&&n.user&&n.user.setLayoutPreference("Uploaders.Html."+t,r)}}],n&&k(r.prototype,n),o&&k(r,o),Object.defineProperty(r,"prototype",{writable:!1}),c}(c());function x(t){return x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},x(t)}function R(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==x(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==x(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===x(o)?o:String(o)),n)}var o}function L(t,e){return L=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},L(t,e)}function I(t){return I=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},I(t)}var N=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&L(t,e)}(s,t);var e,r,n,o,i=(n=s,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=I(n);if(o){var r=I(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return function(t,e){if(e&&("object"===x(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(this,t)});function s(t,e){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,s),(r=i.call(this,"part",null,t))._label="Part "+e,r._retry=0,r}return e=s,r=[{key:"setRetry",value:function(t){this._retry=t}},{key:"getRetry",value:function(){return this._retry||0}},{key:"setProgress",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._progress=t,this.notify("progress",t),null!==e&&this.notify("bytes",e)}}],r&&R(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),s}(b);const C=require("pydio/http/api");var A=r.n(C);function F(t){return F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},F(t)}function M(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==F(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==F(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===F(o)?o:String(o)),n)}var o}function D(){return D="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var n=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=U(t)););return t}(t,e);if(n){var o=Object.getOwnPropertyDescriptor(n,e);return o.get?o.get.call(arguments.length<3?t:r):o.value}},D.apply(this,arguments)}function z(t,e){return z=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},z(t,e)}function B(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function U(t){return U=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},U(t)}var q=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&z(t,e)}(u,t);var r,n,o,i,s=(o=u,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=U(o);if(i){var r=U(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return function(t,e){if(e&&("object"===F(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return B(t)}(this,t)});function u(t,e){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:void 0;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,u),(r=s.call(this,"file",e,o))._file=t,r._status="new",r._userMeta=i,r._label=n?a().getBasename(n):t.name,t.size>A().getMultipartThreshold()&&r.createParts(),o&&o.addChild(B(r)),r}return r=u,n=[{key:"createParts",value:function(){var t=A().getMultipartPartSize();this._parts=[];for(var e=0;e<Math.ceil(this._file.size/t);e++)this._parts.push(new N(this,e+1))}},{key:"setRetry",value:function(t){this._retry=t}},{key:"getRetry",value:function(){return this._retry||0}},{key:"onError",value:function(t){D(U(u.prototype),"onError",this).call(this,t),this._parts&&this._parts.filter((function(t){return t.getStatus()===b.StatusLoading})).forEach((function(e){return e.onError(t)}))}},{key:"getFile",value:function(){return this._file}},{key:"getSize",value:function(){return this._file.size}},{key:"getHumanSize",value:function(){return a().roundFileSize(this._file.size)}},{key:"setProgress",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._progress=t,this.notify("progress",t),null!==e&&this.notify("bytes",e)}},{key:"_parseXHRResponse",value:function(){this.xhr&&this.xhr.responseText&&"OK"!==this.xhr.responseText&&this.onError("Unexpected response: "+this.xhr.responseText)}},{key:"_doProcess",value:function(t){var r=this;this._userAborted=!1;var n=function(){r.setStatus(b.StatusLoaded),r._parseXHRResponse(),t()},o=function(t){if(r._status!==b.StatusError&&t.total){var e=Math.round(100*t.loaded/t.total),n=t.loaded;if(r.setProgress(e,n),r._parts&&t.part&&r._parts[t.part-1]&&t.partLoaded&&t.partTotal){var o=r._parts[t.part-1],i=Math.round(100*t.partLoaded/t.partTotal);if(t.error)o.onError(t.error.message),o.setProgress(0,0);else if(i<100)o.getStatus()!==b.StatusCannotPause&&(o.setStatus(b.StatusLoading),o.setRetry(t.partRetry));else{var s=o.getStatus()===b.StatusCannotPause;o.setStatus(b.StatusLoaded),s&&0===r._parts.filter((function(t){return o.getStatus()===b.StatusCannotPause})).length&&r.setStatus(b.StatusPause)}o.setProgress(i,t.partLoaded)}}},i=e().getMessages(),s=function(e){r.onError(i[210]+": "+e.message),t()};this.setStatus(b.StatusLoading),addEventListener("unload",(function(){r._status===b.StatusLoading&&(console.error("Page unloaded during upload, try to abort upload!"),r._doAbort())}));try{T.getInstance().extensionAllowed(this)}catch(e){return this.onError(e.message),void t()}!function t(e){return r.setRetry(e-1),function(a){if(a&&a.indexOf){if(a.indexOf("422")>=0)return void s(new Error(i["html_uploader.status.error.422"]+" (422)"));if(a.indexOf("403")>=0)return void s(new Error(i["html_uploader.status.error.403"]+" (403)"))}r._userAborted?s(a||new Error(i["html_uploader.status.error.aborted"])):e>=2?s(a):window.setTimeout((function(){r.uploadPresigned(n,o,t(++e))}),150*e)}}(0)()}},{key:"_doAbort",value:function(t){if(this._status!==b.StatusLoaded){if(this.xhr)try{this._userAborted=!0,this.xhr.abort()}catch(t){}this.setStatus(b.StatusError),this.setProgress(0)}}},{key:"_doPause",value:function(){return this.xhr?this.xhr.pause?(this.xhr.pause(),this._parts&&this._parts.length&&this._parts.filter((function(t){return t.getStatus()===b.StatusLoading})).forEach((function(t){return t.setStatus(b.StatusCannotPause)})),b.StatusMultiPause):b.StatusCannotPause:b.StatusNew}},{key:"_doResume",value:function(){this.xhr&&this.xhr.resume&&this.xhr.resume()}},{key:"uploadPresigned",value:function(t,e,r){var n,o=this;try{n=this.getFullPath()}catch(t){return this.setStatus(b.StatusError),void this.setProgress(0)}this.getSize()<A().getMultipartThreshold()?A().getClient().uploadPresigned(this._file,n,t,r,e,this._userMeta).then((function(t){o.xhr=t})):A().getClient().uploadMultipart(this._file,n,t,r,e,this._userMeta).then((function(t){o.xhr=t}))}}],n&&M(r.prototype,n),Object.defineProperty(r,"prototype",{writable:!1}),u}(b);function G(t){return G="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},G(t)}function J(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==G(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==G(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===G(o)?o:String(o)),n)}var o}function H(t,e){return H=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},H(t,e)}function W(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function X(t){return X=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},X(t)}var V=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&H(t,e)}(s,t);var e,r,n,o,i=(n=s,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=X(n);if(o){var r=X(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return function(t,e){if(e&&("object"===G(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return W(t)}(this,t)});function s(t,e){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,s),(r=i.call(this,"folder",e,n))._new=!0,r._label=a().getBasename(t),r.children.pg[r.getId()]=0,n&&n.addChild(W(r)),r}return e=s,(r=[{key:"isNew",value:function(){return this._new}},{key:"setIgnore",value:function(){this.setStatus(b.StatusLoaded),this.children.pg[this.getId()]=100,this.recomputeProgress(),this._new=!1}},{key:"_doProcess",value:function(t){var e=this;if(this._new){var r;try{r=this.getFullPath()}catch(t){return void this.setStatus(b.StatusError)}var n=new l.TreeServiceApi(A().getRestClient()),o=new l.RestCreateNodesRequest,i=new l.TreeNode;i.Path=r,i.Type=l.TreeNodeType.constructFromObject("COLLECTION"),o.Nodes=[i],n.createNodes(o).then((function(r){e.setStatus(b.StatusLoaded),e.children.pg[e.getId()]=100,e.recomputeProgress(),t()}))}else t()}}])&&J(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),s}(b),Y=r(381),K=r.n(Y);function Q(t){return Q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Q(t)}function $(){$=function(){return t};var t={},e=Object.prototype,r=e.hasOwnProperty,n=Object.defineProperty||function(t,e,r){t[e]=r.value},o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",a=o.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function c(t,e,r,o){var i=e&&e.prototype instanceof h?e:h,s=Object.create(i.prototype),a=new O(o||[]);return n(s,"_invoke",{value:S(t,r,a)}),s}function l(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}t.wrap=c;var f={};function h(){}function p(){}function y(){}var d={};u(d,i,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(E([])));g&&g!==e&&r.call(g,i)&&(d=g);var b=y.prototype=h.prototype=Object.create(d);function m(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function _(t,e){function o(n,i,s,a){var u=l(t[n],t,i);if("throw"!==u.type){var c=u.arg,f=c.value;return f&&"object"==Q(f)&&r.call(f,"__await")?e.resolve(f.__await).then((function(t){o("next",t,s,a)}),(function(t){o("throw",t,s,a)})):e.resolve(f).then((function(t){c.value=t,s(c)}),(function(t){return o("throw",t,s,a)}))}a(u.arg)}var i;n(this,"_invoke",{value:function(t,r){function n(){return new e((function(e,n){o(t,r,e,n)}))}return i=i?i.then(n,n):n()}})}function S(t,e,r){var n="suspendedStart";return function(o,i){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===o)throw i;return{value:void 0,done:!0}}for(r.method=o,r.arg=i;;){var s=r.delegate;if(s){var a=w(s,r);if(a){if(a===f)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=l(t,e,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===f)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg)}}}function w(t,e){var r=e.method,n=t.iterator[r];if(void 0===n)return e.delegate=null,"throw"===r&&t.iterator.return&&(e.method="return",e.arg=void 0,w(t,e),"throw"===e.method)||"return"!==r&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+r+"' method")),f;var o=l(n,t.iterator,e.arg);if("throw"===o.type)return e.method="throw",e.arg=o.arg,e.delegate=null,f;var i=o.arg;return i?i.done?(e[t.resultName]=i.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,f):i:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,f)}function P(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function k(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function O(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(P,this),this.reset(!0)}function E(t){if(t){var e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,o=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=void 0,e.done=!0,e};return o.next=o}}return{next:j}}function j(){return{value:void 0,done:!0}}return p.prototype=y,n(b,"constructor",{value:y,configurable:!0}),n(y,"constructor",{value:p,configurable:!0}),p.displayName=u(y,a,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===p||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,y):(t.__proto__=y,u(t,a,"GeneratorFunction")),t.prototype=Object.create(b),t},t.awrap=function(t){return{__await:t}},m(_.prototype),u(_.prototype,s,(function(){return this})),t.AsyncIterator=_,t.async=function(e,r,n,o,i){void 0===i&&(i=Promise);var s=new _(c(e,r,n,o),i);return t.isGeneratorFunction(r)?s:s.next().then((function(t){return t.done?t.value:s.next()}))},m(b),u(b,a,"Generator"),u(b,i,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},t.values=E,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!t)for(var e in this)"t"===e.charAt(0)&&r.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function n(r,n){return s.type="throw",s.arg=t,e.next=r,n&&(e.method="next",e.arg=void 0),!!n}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],s=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var a=r.call(i,"catchLoc"),u=r.call(i,"finallyLoc");if(a&&u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(a){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=t,s.arg=e,i?(this.method="next",this.next=i.finallyLoc,f):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),f},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),k(r),f}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;k(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:E(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),f}},t}function Z(t,e,r,n,o,i,s){try{var a=t[i](s),u=a.value}catch(t){return void r(t)}a.done?e(u):Promise.resolve(u).then(n,o)}function tt(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function s(t){Z(i,n,o,s,a,"next",t)}function a(t){Z(i,n,o,s,a,"throw",t)}s(void 0)}))}}function et(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Q(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Q(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Q(o)?o:String(o)),n)}var o}function rt(t,e){return rt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},rt(t,e)}function nt(t){return nt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},nt(t)}var ot=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&rt(t,e)}(c,t);var r,n,o,s,u=(o=c,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=nt(o);if(s){var r=nt(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return function(t,e){if(e&&("object"===Q(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(this,t)});function c(t,e){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,c),(r=u.call(this,"/",e))._repositoryId=t,r._status=b.StatusAnalyze,delete r.children.pg[r.getId()],r._analyzeStatus="",r}return r=c,n=[{key:"getAnalyzeStatus",value:function(){return this._analyzeStatus}},{key:"setAnalyzeStatus",value:function(t){this._analyzeStatus=t,this.notify("status",this._status)}},{key:"setCreateFolders",value:function(t){this._createFoldersStatus=t}},{key:"getCreateFolders",value:function(){return this._createFoldersStatus}},{key:"getFullPath",value:function(){var t=e().getInstance().user.getRepositoriesList();if(!t.has(this._repositoryId))throw new Error("Repository disconnected?");var r=t.get(this._repositoryId).getSlug(),n=this._targetNode.getPath();return(n=i().trimRight(n,"/")).normalize&&(n=n.normalize("NFC")),r+n}},{key:"treeViewFromMaterialPath",value:function(t){var e=[];return Object.keys(t).forEach((function(r){var n=r.split("/");n.shift();var o=e;n.forEach((function(e){var n=o.find((function(t){return t.name===e}));if(n)o=n.children;else{var i={name:e,item:t[r],path:r,children:[]};o.push(i),o=i.children}}))})),e}},{key:"bulkStatSliced",value:function(t,e,r){this.setAnalyzeStatus("checking "+e.length+" items");for(var n=Promise.resolve({Nodes:[]}),o=e.slice(0,r),i=function(){e=e.slice(r);var i=new l.RestGetBulkMetaRequest;i.NodePaths=o,n=n.then((function(e){return t.bulkStatNodes(i).then((function(t){return e.Nodes=e.Nodes.concat(t.Nodes||[]),e}))})),o=e.slice(0,r)};o.length;)i();return n}},{key:"prepare",value:function(t){var r=this;if("overwrite"===t)return this.setStatus("ready"),Promise.resolve();var n=e().getInstance().getPluginConfigs("uploader.html").get("DEFAULT_STAT_SLICES"),o=400;n&&!isNaN(parseInt(n))&&(o=parseInt(n)),this.setStatus(b.StatusAnalyze);var i=new l.TreeServiceApi(A().getRestClient()),s=new l.RestGetBulkMetaRequest;return s.NodePaths=[],this.walk((function(t){s.NodePaths.push(t.getFullPath())}),(function(){return!0}),"both"),new Promise((function(e,n){var u=[];r.bulkStatSliced(i,s.NodePaths,o).then((function(n){if(!n.Nodes||!n.Nodes.length)return r.setStatus("ready"),void e(u);if("alert"===t)return r.setStatus("confirm"),void e();var o,i=function(t){return-1!==n.Nodes.map((function(t){return t.Path})).indexOf(t.getFullPath())};if(o=function(){var t=[];r.walk((function(e){i(e)&&t.push(e)}),(function(){return!0}),"file");var e=new(K())((function(){if(!t.length)return null;var e=t.pop();return new Promise(function(){var t=tt($().mark((function t(n){var o,i;return $().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,r.newPath(e.getFullPath());case 2:o=t.sent,i=a().getBasename(o),e.updateLabel(i),r.setAnalyzeStatus("checking "+i),n();case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}),5);return e.start()},"rename-folders"===t){var s=Promise.resolve();r.walk((function(t){s=s.then(tt($().mark((function e(){var n,o;return $().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!i(t)){e.next=7;break}return e.next=3,r.newPath(t.getFullPath(),!0);case 3:n=e.sent,o=a().getBasename(n),t.updateLabel(o),r.setAnalyzeStatus("checking "+o);case 7:case"end":return e.stop()}}),e)}))))}),(function(){return!0}),"folder"),s.then((function(){return o()})).then((function(t){r.setStatus("ready"),e(t)}))}else r.walk((function(t){i(t)&&t.setIgnore&&t.setIgnore()}),(function(){return!0}),"folder"),o().then((function(t){r.setStatus("ready"),e(t)}))}))}))}},{key:"newPath",value:function(t){var e=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise(function(){var n=tt($().mark((function n(o){var i,s,a,u,c,l,f;return $().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:i=t,s="",r||(a=t.lastIndexOf("/"),(u=t.lastIndexOf("."))>-1&&a<u&&u>a+1&&(i=t.substring(0,u),s=t.substring(u))),c=t,l=1,f=!0;case 6:if(!f){n.next=14;break}return c=i+"-"+l+s,l++,n.next=11,e.nodeExists(c);case 11:f=n.sent,n.next=6;break;case 14:o(c);case 15:case"end":return n.stop()}}),n)})));return function(t){return n.apply(this,arguments)}}())}},{key:"nodeExists",value:function(t){return new Promise((function(e){var r=new l.TreeServiceApi(A().getRestClient()),n=new l.RestGetBulkMetaRequest;n.NodePaths=[t],r.bulkStatNodes(n).then((function(t){t.Nodes&&t.Nodes[0]?e(!0):e(!1)})).catch((function(){return e(!1)}))}))}}],n&&et(r.prototype,n),Object.defineProperty(r,"prototype",{writable:!1}),c}(V);const it=require("pydio/model/meta-node-provider");var st=r.n(it);function at(t){return at="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},at(t)}function ut(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==at(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==at(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===at(o)?o:String(o)),n)}var o}function ct(t,e){return ct=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},ct(t,e)}function lt(t){return lt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},lt(t)}var ft=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&ct(t,e)}(f,t);var r,n,o,s,u,c=(s=f,u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=lt(s);if(u){var r=lt(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return function(t,e){if(e&&("object"===at(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(this,t)});function f(){var t;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,f),(t=c.call(this))._processing=[],t._sessions=[],t._blacklist=[".ds_store",".pydio"],t._pauseRequired=!1,st().RegisterLoaderHook("uploads",(function(e){t._sessions.forEach((function(r){t.sessionToNodes(r,e)}))})),t}return r=f,n=[{key:"getAutoStart",value:function(){return T.getInstance().getAutoStart()}},{key:"makeStatusString",value:function(t){var r="html_uploader.status."+("file"===t.getType()?"file":"dir")+"."+t.getStatus();return e().getMessages()[r]||r}},{key:"createNode",value:function(t,e){var r=new l.TreeNode;return r.Path=i().trim(e,"/"),r.Type="file"===t.getType()?"LEAF":"COLLECTION",t.getSize&&(r.Size=t.getSize()),r.MTime=Math.round(new Date/1e3),r.MetaStore={"local:entryDescription":'"'+this.makeStatusString(t)+'"',"local:UploadStatus":'"'+t.getStatus()+'"',"local:UploadProgress":t.getProgress()||0},st().parseTreeNode(r)}},{key:"sessionToNodes",value:function(t){var r=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;null===n&&(n=t.getTargetNode());var o=e().getInstance().user.getActiveRepositoryObject(),s=n.getPath();t.walk((function(t){var e=function(t){return(s+"/"+t.getLabel()).replace("//","/")},o=e(t);n.findChildByPath(o)||t.getStatus()===b.StatusLoaded||t.getStatus()===b.StatusError||n.addChild(r.createNode(t,o)),t.observe("update_label",(function(o){var i=r.createNode(t,e(t));n.addChild(i)})),t.observe("progress",(function(o){var i=n.findChildByPath(e(t));i||(i=r.createNode(t,e(t)),n.addChild(i)),"file"===t.getType()&&i.getMetadata().get("local:UploadProgress")!==o&&(i.getMetadata().set("local:entryDescription",r.makeStatusString(t)),i.getMetadata().set("local:UploadStatus",t.getStatus()),i.getMetadata().set("local:UploadProgress",o),i.setMetadata(i.getMetadata(),!0))})),t.observe("status",(function(o){var i=n.findChildByPath(e(t));i&&(o===b.StatusLoaded?(i.getMetadata().delete("local:entryDescription"),i.getMetadata().delete("local:UploadStatus"),i.getMetadata().delete("local:UploadProgress")):(i.getMetadata().set("local:UploadStatus",o),i.getMetadata().set("local:entryDescription",r.makeStatusString(t))),i.setMetadata(i.getMetadata(),!0)),t.getStatus()===b.StatusError&&setTimeout((function(){var r=n.findChildByPath(e(t));r&&r.getParent()&&!r.getMetadata().has("uuid")&&r.getParent().removeChild(r)}),1500)}))}),(function(t){var e=i().trim(o.getSlug()+n.getPath(),"/"),r=a().getDirname(t.getFullPath());return o.getId()===t.getRepositoryId()&&r===e}))}},{key:"pushSession",value:function(t){var e=this;this._sessions.push(t),t.Task=w.create(t),t.observe("update",(function(){e.notify("update")})),t.observe("children",(function(){0===t.getChildren().length&&e.removeSession(t),e.sessionToNodes(t),e.notify("update")})),t.observe("child_added",(function(){e.sessionToNodes(t)})),this.notify("update"),t.observe("status",(function(t){if("ready"===t){var r=e.getAutoStart();!r||e._processing.length||e._pauseRequired?r||f.openUploadDialog():e.processNext()}else"confirm"===t&&f.openUploadDialog(!0)})),this.notify("session_added",t)}},{key:"removeSession",value:function(t){t.Task.setIdle();var e=this._sessions.indexOf(t);this._sessions=i().arrayWithout(this._sessions,e),this.notify("update")}},{key:"log",value:function(){}},{key:"hasQueue",value:function(){var t=0;return this._sessions.forEach((function(e){e.walk((function(){t++}),(function(t){return t.getStatus()===b.StatusNew||t.getStatus()===b.StatusPause||t.getStatus()===b.StatusMultiPause}),"both",(function(){return t>=1}))})),t>0}},{key:"hasErrors",value:function(){var t=0;return this._sessions.forEach((function(e){e.walk((function(){t++}),(function(t){return"error"===t.getStatus()}),"both",(function(){return t>=1}))})),t>0}},{key:"clearAll",value:function(){var t=this;this.clearStatus("new"),this._sessions.forEach((function(e){e.walk((function(t){t.getParent().removeChild(t)})),e.Task.setIdle(),t.removeSession(e)})),this._pauseRequired=!1,this.notify("update")}},{key:"clearStatus",value:function(t){this._sessions.forEach((function(e){e.walk((function(t){t.getParent().removeChild(t)}),(function(e){return e.getStatus()===t}),b.TypeFile),e.walk((function(t){t.getParent().removeChild(t)}),(function(t){var e=0;return t.walk((function(){e++}),(function(){return!0}),b.TypeFile),0===e}),b.TypeFolder)}))}},{key:"monitorProcessing",value:function(t){var e=this;this._processingMonitor||(this._processingMonitor=function(){e.notify("update")}),t.observe("status",this._processingMonitor),this._processing.push(t)}},{key:"unmonitorProcessing",value:function(t){var e=this._processing.indexOf(t);e>-1&&(this._processingMonitor&&t.stopObserving("status",this._processingMonitor),this._processing=i().arrayWithout(this._processing,e))}},{key:"processNext",value:function(){var t=this,e=this.getFolders();if(e.length&&!this._pauseRequired){var r=new l.TreeServiceApi(A().getRestClient()),n=new l.RestCreateNodesRequest;return n.Nodes=[],e.forEach((function(e){var r=new l.TreeNode;r.Path=e.getFullPath(),r.Type=l.TreeNodeType.constructFromObject("COLLECTION"),n.Nodes.push(r),e.setStatus(b.StatusLoading),t.monitorProcessing(e)})),this.notify("update"),void r.createNodes(n).then((function(){e.forEach((function(e){e.setStatus(b.StatusLoaded),e.children.pg[e.getId()]=100,e.recomputeProgress(),t.unmonitorProcessing(e)})),t.processNext(),t.notify("update")})).catch((function(e){t.processNext(),t.notify("update")}))}var o=this.getNexts();o.length&&!this._pauseRequired?(o.forEach((function(e){t.monitorProcessing(e),e.process((function(){t.unmonitorProcessing(e),t.processNext(),t.notify("update")}))})),this.notify("update")):(this.hasErrors()?f.openUploadDialog():T.getInstance().getAutoClose()&&!this._pauseRequired&&this.notify("auto_close"),this.notify("update"))}},{key:"getFolders",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:60,e=[];return this._sessions.forEach((function(r){var n=0;r.walk((function(t){e.push(t),n++}),(function(t){return"new"===t.getStatus()&&t.isNew()}),"folder",(function(){return e.length>=t})),r.setCreateFolders(n),r.setStatus(n?b.StatusFolders:b.StatusLoading)})),e}},{key:"getNexts",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,e=[];if(this._sessions.forEach((function(t){t.walk((function(t){e.push(t)}),(function(t){return"new"===t.getStatus()&&t.isNew()}),"folder",(function(){return e.length>=1}))})),e.length)return[e.shift()];var r=[],n=this._processing.length;return this._sessions.forEach((function(e){var o=0;e.walk((function(t){r.push(t),o++}),(function(t){return"new"===t.getStatus()||"pause"===t.getStatus()}),"file",(function(){return r.length>=t-n})),0===o&&0===n&&e.Task.setIdle()})),r}},{key:"stopOrRemoveItem",value:function(t){t.abort(),this.unmonitorProcessing(t),this.notify("update")}},{key:"getSessions",value:function(){return this._sessions}},{key:"isRunning",value:function(){return this._processing.filter((function(t){return t.getStatus()===b.StatusLoading})).length>0}},{key:"pause",value:function(){this._pauseRequired=!0,this._processing.forEach((function(t){return t.pause()})),this.notify("update")}},{key:"resume",value:function(){this._pauseRequired=!1,this._sessions.forEach((function(t){return t.setStatus("ready")})),this._processing.forEach((function(t){return t.resume()})),this.notify("update"),this.processNext()}},{key:"handleFolderPickerResult",value:function(t,r){var n=this,o=T.getInstance().getOption("DEFAULT_EXISTING","upload_existing"),i=new ot(e().getInstance().user.activeRepository,r);this.pushSession(i);for(var s={},u=0;u<t.length;u++){var c=t[u],l="/"+a().getBasename(c.name);if(t[u].webkitRelativePath){l="/"+t[u].webkitRelativePath;var f=a().getDirname(l);"/"!==f&&(s[a().getDirname(f)]="FOLDER"),s[f]="FOLDER"}s[l]=c}!function t(e,o){e.forEach((function(e){if("FOLDER"===e.item){var i=new V(e.path,r,o);t(e.children,i)}else-1===n._blacklist.indexOf(a().getBasename(e.path).toLowerCase())&&new q(e.item,r,e.path,o)}))}(i.treeViewFromMaterialPath(s),i),i.prepare(o).catch((function(t){}))}},{key:"handleDropEventResults",value:function(t,r,n){var o=this,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,u=T.getInstance().getOption("DEFAULT_EXISTING","upload_existing"),c=new ot(s||e().getInstance().user.activeRepository,n);this.pushSession(c);var l=function(t){return!(i&&!i(t))&&-1===o._blacklist.indexOf(a().getBasename(t).toLowerCase())};if(n&&n.isLeaf()&&n.getMetadata().has("local:dropFunc"))n.getMetadata().get("local:dropFunc")("native",c,t,r,n).then((function(){c.prepare(u).then((function(){o.notify("update")})).catch((function(t){o.notify("update")}))})).catch((function(t){o.removeSession(c),console.error(t)}));else if(t&&t.length&&(t[0].getAsEntry||t[0].webkitGetAsEntry)){for(var f=console?console.log:function(t){alert(t)},h=t.length,p=[],y=function(){var e;if(t[d].kind&&"file"!==t[d].kind)return"continue";(e=t[0].getAsEntry?t[d].getAsEntry():t[d].webkitGetAsEntry()).isFile?p.push(new Promise((function(t,r){e.file((function(e){var r;e.size>0&&l(e.name)&&(r=new q(e,n,null,c)),t(r)}),(function(){r(),f()}))}))):e.isDirectory&&(e.folderItem=new V(e.fullPath,n,c),p.push(o.recurseDirectory(e,(function(t){var e=t.fullPath;return new Promise((function(r,o){t.file((function(o){var i;o.size>0&&l(o.name)&&(i=new q(o,n,e,t.parentItem)),r(i)}),(function(t){o(t),f()}))}))}),(function(t){return l(t.fullPath)&&(t.folderItem=new V(t.fullPath,n,t.parentItem)),Promise.resolve(t.folderItem)}),f)))},d=0;d<h;d++)y();Promise.all(p).then((function(){return c.prepare(u).then((function(){o.notify("update")}))})).catch((function(t){o.notify("update")}))}else{for(var v=0;v<r.length;v++){if(0===r[v].size)return void alert(e().getInstance().MessageHash["html_uploader.no-folders-support"]);if(!l(r[v].name))return;new q(r[v],n,null,c)}c.prepare(u).then((function(){o.notify("update")})).catch((function(t){o.notify("update")}))}}},{key:"recurseDirectory",value:function(t,e,r,n){var o=this;return new Promise((function(n){o.dirEntries(t).then((function(t){var o=[];t.forEach((function(t){t.parent&&t.parent.folderItem&&(t.parentItem=t.parent.folderItem),t.isDirectory?o.push(r(t)):o.push(e(t))})),Promise.all(o).then((function(){n()}))}))}))}},{key:"dirEntries",value:function(t){var e=this,r=t.createReader(),n=[];return new Promise((function(o,i){!function s(){r.readEntries((function(r){if(r.length)n=n.concat((a=r,Array.prototype.slice.call(a||[],0))),s();else{var i=[];n.forEach((function(r){r.parent=t,r.isDirectory&&i.push(e.dirEntries(r).then((function(t){n=n.concat(t)})))})),i.length?Promise.all(i).then((function(){o(n)})):o(n)}var a}),(function(t){i(t)}))}()}))}}],o=[{key:"openUploadDialog",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]?e().getInstance().getController().fireAction("upload",{confirmDialog:!0}):e().getInstance().getController().fireAction("upload")}},{key:"getInstance",value:function(){return f.__INSTANCE||(f.__INSTANCE=new f),f.__INSTANCE}}],n&&ut(r.prototype,n),o&&ut(r,o),Object.defineProperty(r,"prototype",{writable:!1}),f}(c())})(),window.UploaderModel=n})();